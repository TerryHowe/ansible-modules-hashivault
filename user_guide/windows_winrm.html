

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Windows Remote Management &mdash; Ansible Documentation</title>
  

  
  
  
  
    <link rel="canonical" href="https://docs.ansible.com/ansible/latest/user_guide/windows_winrm.html"/>
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>
  <link href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.min.css' rel='stylesheet' type='text/css'>

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/ansible.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/ansible.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Using Ansible and Windows" href="windows_usage.html" />
    <link rel="prev" title="Setting up a Windows Host" href="windows_setup.html" /> <!---- extra head elements for Ansible beyond RTD Sphinx Theme --->
<script type="text/javascript" src="//www.redhat.com/dtm.js"></script>
<!-- <meta class="swiftype" name="published_at" data-type="date" content="2017-12-13" /> -->
<meta class="swiftype" name="version" data-type="string" content="2.9">

<!-- Google Tag Manager Data Layer -->
<script>
 dataLayer = [];
</script>
<!-- End Google Tag Manager Data Layer -->

<script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script> 
</head>

<body class="wy-body-for-nav">
   <!---- extra body elements for Ansible beyond RTD Sphinx Theme --->
<!-- Google Tag Manager -->
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-PSB293" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-PSB293');</script>
<!-- End Google Tag Manager -->

  <div class="DocSite-globalNav ansibleNav">
      <ul>
          <li><a href="https://www.ansible.com/ansiblefest" target="_blank">AnsibleFest</a></li>
          <li><a href="https://www.ansible.com/tower" target="_blank">Products</a></li>
          <li><a href="https://www.ansible.com/community" target="_blank">Community</a></li>
          <li><a href="https://www.ansible.com/webinars-training" target="_blank">Webinars & Training</a></li>
          <li><a href="https://www.ansible.com/blog" target="_blank">Blog</a></li>
      </ul>
  </div>

<a class="DocSite-nav" href="/" style="padding-bottom: 30px;">

  <img class="DocSiteNav-logo"
    src="../_static/images/logo_invert.png"
    alt="Ansible Logo">
  <div class="DocSiteNav-title">
    Documentation
  </div>
</a> 
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Ansible
          

          
          </a>

          
            
            
              <div class="version">
                2.9
              </div>
            
          

          <!--- Based on https://github.com/rtfd/sphinx_rtd_theme/pull/438/files -->

<div class="version">
  
    <div class="version-dropdown">
      <select class="version-list" id="version-list" onchange="javascript:location.href = this.value;">
        <script> x = document.getElementById("version-list"); </script>
        
          <script>
            current_url = window.location.href;
            option = document.createElement("option");
            option.text = "latest";
            if ( "latest" == "2.9" ) {
              option.selected = true;
            }
            if (current_url.search("2.9") > -1) {
              option.value = current_url.replace("2.9","latest");
            } else {
              option.value = current_url.replace("latest","latest");
            }
            x.add(option);
          </script>
        
          <script>
            current_url = window.location.href;
            option = document.createElement("option");
            option.text = "2.8";
            if ( "2.8" == "2.9" ) {
              option.selected = true;
            }
            if (current_url.search("2.9") > -1) {
              option.value = current_url.replace("2.9","2.8");
            } else {
              option.value = current_url.replace("latest","2.8");
            }
            x.add(option);
          </script>
        
          <script>
            current_url = window.location.href;
            option = document.createElement("option");
            option.text = "2.7";
            if ( "2.7" == "2.9" ) {
              option.selected = true;
            }
            if (current_url.search("2.9") > -1) {
              option.value = current_url.replace("2.9","2.7");
            } else {
              option.value = current_url.replace("latest","2.7");
            }
            x.add(option);
          </script>
        
          <script>
            current_url = window.location.href;
            option = document.createElement("option");
            option.text = "devel";
            if ( "devel" == "2.9" ) {
              option.selected = true;
            }
            if (current_url.search("2.9") > -1) {
              option.value = current_url.replace("2.9","devel");
            } else {
              option.value = current_url.replace("latest","devel");
            }
            x.add(option);
          </script>
        
      </select>
    </div>
  
</div>
          
<div role="search">
<!--  <form id="rtd-search-form" class="wy-form" action="../search.html" -->
  <form id="rtd-search-form" class="wy-form"  method="get">
    <input type="text" class="st-default-search-input" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation, Upgrade &amp; Configuration</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation_guide/index.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../porting_guides/porting_guides.html">Ansible Porting Guides</a></li>
</ul>
<p class="caption"><span class="caption-text">Using Ansible</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">User Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="quickstart.html">Ansible Quickstart Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="basic_concepts.html">Ansible concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro_getting_started.html">Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro_inventory.html">How to build your inventory</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro_dynamic_inventory.html">Working with dynamic inventory</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro_patterns.html">Patterns: targeting hosts and groups</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro_adhoc.html">Introduction to ad-hoc commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="connection_details.html">Connection methods and details</a></li>
<li class="toctree-l2"><a class="reference internal" href="command_line_tools.html">Working with command line tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="playbooks.html">Working With Playbooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="become.html">Understanding privilege escalation: become</a></li>
<li class="toctree-l2"><a class="reference internal" href="vault.html">Ansible Vault</a></li>
<li class="toctree-l2"><a class="reference internal" href="modules.html">Working With Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plugins/plugins.html">Working With Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro_bsd.html">Ansible and BSD</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="windows.html">Windows Guides</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="windows_setup.html">Setting up a Windows Host</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Windows Remote Management</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#what-is-winrm">What is WinRM?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#authentication-options">Authentication Options</a></li>
<li class="toctree-l4"><a class="reference internal" href="#non-administrator-accounts">Non-Administrator Accounts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#winrm-encryption">WinRM Encryption</a></li>
<li class="toctree-l4"><a class="reference internal" href="#inventory-options">Inventory Options</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ipv6-addresses">IPv6 Addresses</a></li>
<li class="toctree-l4"><a class="reference internal" href="#https-certificate-validation">HTTPS Certificate Validation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tls-1-2-support">TLS 1.2 Support</a></li>
<li class="toctree-l4"><a class="reference internal" href="#limitations">Limitations</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="windows_usage.html">Using Ansible and Windows</a></li>
<li class="toctree-l3"><a class="reference internal" href="windows_dsc.html">Desired State Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="windows_performance.html">Windows performance</a></li>
<li class="toctree-l3"><a class="reference internal" href="windows_faq.html">Windows Frequently Asked Questions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="collections_using.html">Using collections</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Contributing to Ansible</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../community/index.html">Ansible Community Guide</a></li>
</ul>
<p class="caption"><span class="caption-text">Extending Ansible</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dev_guide/index.html">Developer Guide</a></li>
</ul>
<p class="caption"><span class="caption-text">Common Ansible Scenarios</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../scenario_guides/cloud_guides.html">Public Cloud Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scenario_guides/network_guides.html">Network Technology Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scenario_guides/virt_guides.html">Virtualization and Containerization Guides</a></li>
</ul>
<p class="caption"><span class="caption-text">Ansible for Network Automation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../network/index.html">Ansible for Network Automation</a></li>
</ul>
<p class="caption"><span class="caption-text">Ansible Galaxy</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../galaxy/user_guide.html">Galaxy User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../galaxy/dev_guide.html">Galaxy Developer Guide</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference &amp; Appendices</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules/modules_by_category.html">Module Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/playbooks_keywords.html">Playbook Keywords</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/common_return_values.html">Return Values</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/config.html">Ansible Configuration Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/general_precedence.html">Controlling how Ansible behaves: precedence rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/YAMLSyntax.html">YAML Syntax</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/python_3_support.html">Python 3 Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/interpreter_discovery.html">Interpreter Discovery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/release_and_maintenance.html">Release and maintenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/test_strategies.html">Testing Strategies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_guide/testing/sanity/index.html">Sanity Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/module_utils.html">Ansible Reference: Module Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/special_variables.html">Special Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/tower.html">Red Hat Ansible Tower</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/logging.html">Logging Ansible output</a></li>
</ul>
<p class="caption"><span class="caption-text">Roadmaps</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../roadmap/index.html">Ansible Roadmap</a></li>
</ul>

            
          
        </div>
        
         <!-- extra nav elements for Ansible beyond RTD Sphinx Theme --->
<!-- changeable widget links to tower - do not change as image controlled by Ansible-->
<div id="sideBanner">
  <br/>
  <a href="https://www.ansible.com/docs-left?utm_source=docs">
    <img style="border-width:0px;" src="https://cdn2.hubspot.net/hubfs/330046/docs-graphics/ASB-docs-left-rail.png" />
  </a>
  <br/><br/><br/>
</div>
      </div>
    </nav>
  </div>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Ansible</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          
















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">User Guide</a> &raquo;</li>
        
          <li><a href="windows.html">Windows Guides</a> &raquo;</li>
        
      <li>Windows Remote Management</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <!-- Ansible-specific additions for modules etc -->
                
                  <a href="https://github.com/ansible/ansible/edit/devel/docs/docsite/rst/user_guide/windows_winrm.rst?description=%23%23%23%23%23%20SUMMARY%0A%3C!---%20Your%20description%20here%20--%3E%0A%0A%0A%23%23%23%23%23%20ISSUE%20TYPE%0A-%20Docs%20Pull%20Request%0A%0A%2Blabel:%20docsite_pr" class="fa fa-github"> Edit on GitHub</a>
                
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <!--- Based on sphinx versionwarning extension. Extension currently only works on READTHEDOCS -->
  <script>
    // Create a banner if we're not on the official docs site
    if (location.host == "docs.testing.ansible.com") {
      document.write('<div id="testing_banner_id" class="admonition important">');
      para = document.createElement('p');
      banner_text=document.createTextNode("This is a testing site. For the official docs go to https://docs.ansible.com/");
      para.appendChild(banner_text);
      element = document.getElementById('testing_banner_id');
      element.appendChild(para);
      document.write('</div>');
    }

    // Create a banner if we're not the latest version
    current_url = window.location.href;
    if ((current_url.search("latest") > -1) || (current_url.search("/2.9/") > -1)) {
     // no banner for latest release
    } else if (current_url.search("devel") > -1) {
      document.write('<div id="banner_id" class="admonition caution">');
      para = document.createElement('p');
      banner_text=document.createTextNode("You are reading the *devel* version of the Ansible documentation - this version is not guaranteed stable. Use the version selection to the left if you want the latest stable released version.");
      para.appendChild(banner_text);
      element = document.getElementById('banner_id');
      element.appendChild(para);
      document.write('</div>');
    } else {
      document.write('<div id="banner_id" class="admonition caution">');
      para = document.createElement('p');
      banner_text=document.createTextNode("You are reading an older version of the Ansible documentation. Use the version selection to the left if you want the latest stable released version.");
      para.appendChild(banner_text);
      element = document.getElementById('banner_id');
      element.appendChild(para);
      document.write('</div>');
    }
  </script>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="windows-remote-management">
<span id="windows-winrm"></span><h1>Windows Remote Management<a class="headerlink" href="#windows-remote-management" title="Permalink to this headline">¶</a></h1>
<p>Unlike Linux/Unix hosts, which use SSH by default, Windows hosts are
configured with WinRM. This topic covers how to configure and use WinRM with Ansible.</p>
<div class="contents local topic" id="topics">
<p class="topic-title">Topics</p>
<ul class="simple">
<li><p><a class="reference internal" href="#what-is-winrm" id="id1">What is WinRM?</a></p></li>
<li><p><a class="reference internal" href="#authentication-options" id="id2">Authentication Options</a></p>
<ul>
<li><p><a class="reference internal" href="#basic" id="id3">Basic</a></p></li>
<li><p><a class="reference internal" href="#certificate" id="id4">Certificate</a></p>
<ul>
<li><p><a class="reference internal" href="#generate-a-certificate" id="id5">Generate a Certificate</a></p></li>
<li><p><a class="reference internal" href="#import-a-certificate-to-the-certificate-store" id="id6">Import a Certificate to the Certificate Store</a></p></li>
<li><p><a class="reference internal" href="#mapping-a-certificate-to-an-account" id="id7">Mapping a Certificate to an Account</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#ntlm" id="id8">NTLM</a></p></li>
<li><p><a class="reference internal" href="#kerberos" id="id9">Kerberos</a></p>
<ul>
<li><p><a class="reference internal" href="#installing-the-kerberos-library" id="id10">Installing the Kerberos Library</a></p></li>
<li><p><a class="reference internal" href="#configuring-host-kerberos" id="id11">Configuring Host Kerberos</a></p></li>
<li><p><a class="reference internal" href="#automatic-kerberos-ticket-management" id="id12">Automatic Kerberos Ticket Management</a></p></li>
<li><p><a class="reference internal" href="#manual-kerberos-ticket-management" id="id13">Manual Kerberos Ticket Management</a></p></li>
<li><p><a class="reference internal" href="#troubleshooting-kerberos" id="id14">Troubleshooting Kerberos</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#credssp" id="id15">CredSSP</a></p>
<ul>
<li><p><a class="reference internal" href="#installing-credssp-library" id="id16">Installing CredSSP Library</a></p></li>
<li><p><a class="reference internal" href="#credssp-and-tls-1-2" id="id17">CredSSP and TLS 1.2</a></p></li>
<li><p><a class="reference internal" href="#set-credssp-certificate" id="id18">Set CredSSP Certificate</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#non-administrator-accounts" id="id19">Non-Administrator Accounts</a></p></li>
<li><p><a class="reference internal" href="#winrm-encryption" id="id20">WinRM Encryption</a></p></li>
<li><p><a class="reference internal" href="#inventory-options" id="id21">Inventory Options</a></p></li>
<li><p><a class="reference internal" href="#ipv6-addresses" id="id22">IPv6 Addresses</a></p></li>
<li><p><a class="reference internal" href="#https-certificate-validation" id="id23">HTTPS Certificate Validation</a></p></li>
<li><p><a class="reference internal" href="#tls-1-2-support" id="id24">TLS 1.2 Support</a></p></li>
<li><p><a class="reference internal" href="#limitations" id="id25">Limitations</a></p></li>
</ul>
</div>
<div class="section" id="what-is-winrm">
<h2><a class="toc-backref" href="#id1">What is WinRM?</a><a class="headerlink" href="#what-is-winrm" title="Permalink to this headline">¶</a></h2>
<p>WinRM is a management protocol used by Windows to remotely communicate with
another server. It is a SOAP-based protocol that communicates over HTTP/HTTPS, and is
included in all recent Windows operating systems. Since Windows
Server 2012, WinRM has been enabled by default, but in most cases extra
configuration is required to use WinRM with Ansible.</p>
<p>Ansible uses the <a class="reference external" href="https://github.com/diyan/pywinrm">pywinrm</a> package to
communicate with Windows servers over WinRM. It is not installed by default
with the Ansible package, but can be installed by running the following:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pip install <span class="s2">&quot;pywinrm&gt;=0.3.0&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>on distributions with multiple python versions, use pip2 or pip2.x,
where x matches the python minor version Ansible is running under.</p>
</div>
</div>
<div class="section" id="authentication-options">
<h2><a class="toc-backref" href="#id2">Authentication Options</a><a class="headerlink" href="#authentication-options" title="Permalink to this headline">¶</a></h2>
<p>When connecting to a Windows host, there are several different options that can be used
when authenticating with an account. The authentication type may be set on inventory
hosts or groups with the <code class="docutils literal notranslate"><span class="pre">ansible_winrm_transport</span></code> variable.</p>
<p>The following matrix is a high level overview of the options:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 17%" />
<col style="width: 28%" />
<col style="width: 24%" />
<col style="width: 18%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Option</p></th>
<th class="head"><p>Local Accounts</p></th>
<th class="head"><p>Active Directory Accounts</p></th>
<th class="head"><p>Credential Delegation</p></th>
<th class="head"><p>HTTP Encryption</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Basic</p></td>
<td><p>Yes</p></td>
<td><p>No</p></td>
<td><p>No</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-odd"><td><p>Certificate</p></td>
<td><p>Yes</p></td>
<td><p>No</p></td>
<td><p>No</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-even"><td><p>Kerberos</p></td>
<td><p>No</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-odd"><td><p>NTLM</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
<td><p>No</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-even"><td><p>CredSSP</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
</tr>
</tbody>
</table>
<div class="section" id="basic">
<h3><a class="toc-backref" href="#id3">Basic</a><a class="headerlink" href="#basic" title="Permalink to this headline">¶</a></h3>
<p>Basic authentication is one of the simplest authentication options to use, but is
also the most insecure. This is because the username and password are simply
base64 encoded, and if a secure channel is not in use (eg, HTTPS) then it can be
decoded by anyone. Basic authentication can only be used for local accounts (not domain accounts).</p>
<p>The following example shows host vars configured for basic authentication:</p>
<div class="highlight-yaml+jinja notranslate"><div class="highlight"><pre><span></span><span class="nt">ansible_user</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">LocalUsername</span>
<span class="nt">ansible_password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Password</span>
<span class="nt">ansible_connection</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">winrm</span>
<span class="nt">ansible_winrm_transport</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">basic</span>
</pre></div>
</div>
<p>Basic authentication is not enabled by default on a Windows host but can be
enabled by running the following in PowerShell:</p>
<div class="highlight-YAML+Jinja notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">Set-Item -Path WSMan:\localhost\Service\Auth\Basic -Value $true</span>
</pre></div>
</div>
</div>
<div class="section" id="certificate">
<h3><a class="toc-backref" href="#id4">Certificate</a><a class="headerlink" href="#certificate" title="Permalink to this headline">¶</a></h3>
<p>Certificate authentication uses certificates as keys similar to SSH key
pairs, but the file format and key generation process is different.</p>
<p>The following example shows host vars configured for certificate authentication:</p>
<div class="highlight-yaml+jinja notranslate"><div class="highlight"><pre><span></span><span class="nt">ansible_connection</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">winrm</span>
<span class="nt">ansible_winrm_cert_pem</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/path/to/certificate/public/key.pem</span>
<span class="nt">ansible_winrm_cert_key_pem</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/path/to/certificate/private/key.pem</span>
<span class="nt">ansible_winrm_transport</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">certificate</span>
</pre></div>
</div>
<p>Certificate authentication is not enabled by default on a Windows host but can
be enabled by running the following in PowerShell:</p>
<div class="highlight-YAML+Jinja notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">Set-Item -Path WSMan:\localhost\Service\Auth\Certificate -Value $true</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Encrypted private keys cannot be used as the urllib3 library that
is used by Ansible for WinRM does not support this functionality.</p>
</div>
<div class="section" id="generate-a-certificate">
<h4><a class="toc-backref" href="#id5">Generate a Certificate</a><a class="headerlink" href="#generate-a-certificate" title="Permalink to this headline">¶</a></h4>
<p>A certificate must be generated before it can be mapped to a local user.
This can be done using one of the following methods:</p>
<ul class="simple">
<li><p>OpenSSL</p></li>
<li><p>PowerShell, using the <code class="docutils literal notranslate"><span class="pre">New-SelfSignedCertificate</span></code> cmdlet</p></li>
<li><p>Active Directory Certificate Services</p></li>
</ul>
<p>Active Directory Certificate Services is beyond of scope in this documentation but may be
the best option to use when running in a domain environment. For more information,
see the <a class="reference external" href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc732625(v=ws.11)">Active Directory Certificate Services documentation</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Using the PowerShell cmdlet <code class="docutils literal notranslate"><span class="pre">New-SelfSignedCertificate</span></code> to generate
a certificate for authentication only works when being generated from a
Windows 10 or Windows Server 2012 R2 host or later. OpenSSL is still required to
extract the private key from the PFX certificate to a PEM file for Ansible
to use.</p>
</div>
<p>To generate a certificate with <code class="docutils literal notranslate"><span class="pre">OpenSSL</span></code>:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set the name of the local user that will have the key mapped to</span>
<span class="nv">USERNAME</span><span class="o">=</span><span class="s2">&quot;username&quot;</span>

cat &gt; openssl.conf <span class="s">&lt;&lt; EOL</span>
<span class="s">distinguished_name = req_distinguished_name</span>
<span class="s">[req_distinguished_name]</span>
<span class="s">[v3_req_client]</span>
<span class="s">extendedKeyUsage = clientAuth</span>
<span class="s">subjectAltName = otherName:1.3.6.1.4.1.311.20.2.3;UTF8:$USERNAME@localhost</span>
<span class="s">EOL</span>

<span class="nb">export</span> <span class="nv">OPENSSL_CONF</span><span class="o">=</span>openssl.conf
openssl req -x509 -nodes -days <span class="m">3650</span> -newkey rsa:2048 -out cert.pem -outform PEM -keyout cert_key.pem -subj <span class="s2">&quot;/CN=</span><span class="nv">$USERNAME</span><span class="s2">&quot;</span> -extensions v3_req_client
rm openssl.conf
</pre></div>
</div>
<p>To generate a certificate with <code class="docutils literal notranslate"><span class="pre">New-SelfSignedCertificate</span></code>:</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="c"># Set the name of the local user that will have the key mapped</span>
<span class="nv">$username</span> <span class="p">=</span> <span class="s2">&quot;username&quot;</span>
<span class="nv">$output_path</span> <span class="p">=</span> <span class="s2">&quot;C:\temp&quot;</span>

<span class="c"># Instead of generating a file, the cert will be added to the personal</span>
<span class="c"># LocalComputer folder in the certificate store</span>
<span class="nv">$cert</span> <span class="p">=</span> <span class="nb">New-SelfSignedCertificate</span> <span class="n">-Type</span> <span class="n">Custom</span> <span class="p">`</span>
    <span class="n">-Subject</span> <span class="s2">&quot;CN=$username&quot;</span> <span class="p">`</span>
    <span class="n">-TextExtension</span> <span class="p">@(</span><span class="s2">&quot;2.5.29.37={text}1.3.6.1.5.5.7.3.2&quot;</span><span class="p">,</span><span class="s2">&quot;2.5.29.17={text}upn=$username@localhost&quot;</span><span class="p">)</span> <span class="p">`</span>
    <span class="n">-KeyUsage</span> <span class="n">DigitalSignature</span><span class="p">,</span><span class="n">KeyEncipherment</span> <span class="p">`</span>
    <span class="n">-KeyAlgorithm</span> <span class="n">RSA</span> <span class="p">`</span>
    <span class="n">-KeyLength</span> <span class="n">2048</span>

<span class="c"># Export the public key</span>
<span class="nv">$pem_output</span> <span class="p">=</span> <span class="p">@()</span>
<span class="nv">$pem_output</span> <span class="p">+=</span> <span class="s2">&quot;-----BEGIN CERTIFICATE-----&quot;</span>
<span class="nv">$pem_output</span> <span class="p">+=</span> <span class="no">[System.Convert]</span><span class="p">::</span><span class="n">ToBase64String</span><span class="p">(</span><span class="nv">$cert</span><span class="p">.</span><span class="n">RawData</span><span class="p">)</span> <span class="o">-replace</span> <span class="s2">&quot;.{64}&quot;</span><span class="p">,</span> <span class="s2">&quot;$&amp;</span><span class="se">`n</span><span class="s2">&quot;</span>
<span class="nv">$pem_output</span> <span class="p">+=</span> <span class="s2">&quot;-----END CERTIFICATE-----&quot;</span>
<span class="no">[System.IO.File]</span><span class="p">::</span><span class="n">WriteAllLines</span><span class="p">(</span><span class="s2">&quot;$output_path\cert.pem&quot;</span><span class="p">,</span> <span class="nv">$pem_output</span><span class="p">)</span>

<span class="c"># Export the private key in a PFX file</span>
<span class="no">[System.IO.File]</span><span class="p">::</span><span class="n">WriteAllBytes</span><span class="p">(</span><span class="s2">&quot;$output_path\cert.pfx&quot;</span><span class="p">,</span> <span class="nv">$cert</span><span class="p">.</span><span class="n">Export</span><span class="p">(</span><span class="s2">&quot;Pfx&quot;</span><span class="p">))</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To convert the PFX file to a private key that pywinrm can use, run
the following command with OpenSSL
<code class="docutils literal notranslate"><span class="pre">openssl</span> <span class="pre">pkcs12</span> <span class="pre">-in</span> <span class="pre">cert.pfx</span> <span class="pre">-nocerts</span> <span class="pre">-nodes</span> <span class="pre">-out</span> <span class="pre">cert_key.pem</span> <span class="pre">-passin</span> <span class="pre">pass:</span> <span class="pre">-passout</span> <span class="pre">pass:</span></code></p>
</div>
</div>
<div class="section" id="import-a-certificate-to-the-certificate-store">
<h4><a class="toc-backref" href="#id6">Import a Certificate to the Certificate Store</a><a class="headerlink" href="#import-a-certificate-to-the-certificate-store" title="Permalink to this headline">¶</a></h4>
<p>Once a certificate has been generated, the issuing certificate needs to be
imported into the <code class="docutils literal notranslate"><span class="pre">Trusted</span> <span class="pre">Root</span> <span class="pre">Certificate</span> <span class="pre">Authorities</span></code> of the
<code class="docutils literal notranslate"><span class="pre">LocalMachine</span></code> store, and the client certificate public key must be present
in the <code class="docutils literal notranslate"><span class="pre">Trusted</span> <span class="pre">People</span></code> folder of the <code class="docutils literal notranslate"><span class="pre">LocalMachine</span></code> store. For this example,
both the issuing certificate and public key are the same.</p>
<p>Following example shows how to import the issuing certificate:</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="nv">$cert</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">Cryptography</span><span class="p">.</span><span class="n">X509Certificates</span><span class="p">.</span><span class="n">X509Certificate2</span>
<span class="nv">$cert</span><span class="p">.</span><span class="n">Import</span><span class="p">(</span><span class="s2">&quot;cert.pem&quot;</span><span class="p">)</span>

<span class="nv">$store_name</span> <span class="p">=</span> <span class="no">[System.Security.Cryptography.X509Certificates.StoreName]</span><span class="p">::</span><span class="n">Root</span>
<span class="nv">$store_location</span> <span class="p">=</span> <span class="no">[System.Security.Cryptography.X509Certificates.StoreLocation]</span><span class="p">::</span><span class="n">LocalMachine</span>
<span class="nv">$store</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">Cryptography</span><span class="p">.</span><span class="n">X509Certificates</span><span class="p">.</span><span class="n">X509Store</span> <span class="n">-ArgumentList</span> <span class="nv">$store_name</span><span class="p">,</span> <span class="nv">$store_location</span>
<span class="nv">$store</span><span class="p">.</span><span class="n">Open</span><span class="p">(</span><span class="s2">&quot;MaxAllowed&quot;</span><span class="p">)</span>
<span class="nv">$store</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="nv">$cert</span><span class="p">)</span>
<span class="nv">$store</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If using ADCS to generate the certificate, then the issuing
certificate will already be imported and this step can be skipped.</p>
</div>
<p>The code to import the client certificate public key is:</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="nv">$cert</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">Cryptography</span><span class="p">.</span><span class="n">X509Certificates</span><span class="p">.</span><span class="n">X509Certificate2</span>
<span class="nv">$cert</span><span class="p">.</span><span class="n">Import</span><span class="p">(</span><span class="s2">&quot;cert.pem&quot;</span><span class="p">)</span>

<span class="nv">$store_name</span> <span class="p">=</span> <span class="no">[System.Security.Cryptography.X509Certificates.StoreName]</span><span class="p">::</span><span class="n">TrustedPeople</span>
<span class="nv">$store_location</span> <span class="p">=</span> <span class="no">[System.Security.Cryptography.X509Certificates.StoreLocation]</span><span class="p">::</span><span class="n">LocalMachine</span>
<span class="nv">$store</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">Cryptography</span><span class="p">.</span><span class="n">X509Certificates</span><span class="p">.</span><span class="n">X509Store</span> <span class="n">-ArgumentList</span> <span class="nv">$store_name</span><span class="p">,</span> <span class="nv">$store_location</span>
<span class="nv">$store</span><span class="p">.</span><span class="n">Open</span><span class="p">(</span><span class="s2">&quot;MaxAllowed&quot;</span><span class="p">)</span>
<span class="nv">$store</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="nv">$cert</span><span class="p">)</span>
<span class="nv">$store</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="mapping-a-certificate-to-an-account">
<h4><a class="toc-backref" href="#id7">Mapping a Certificate to an Account</a><a class="headerlink" href="#mapping-a-certificate-to-an-account" title="Permalink to this headline">¶</a></h4>
<p>Once the certificate has been imported, map it to the local user account:</p>
<div class="highlight-YAML+Jinja notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">$username = &quot;username&quot;</span>
<span class="l l-Scalar l-Scalar-Plain">$password = ConvertTo-SecureString -String &quot;password&quot; -AsPlainText -Force</span>
<span class="l l-Scalar l-Scalar-Plain">$credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $username, $password</span>

<span class="l l-Scalar l-Scalar-Plain"># This is the issuer thumbprint which in the case of a self generated cert</span>
<span class="l l-Scalar l-Scalar-Plain"># is the public key thumbprint, additional logic may be required for other</span>
<span class="l l-Scalar l-Scalar-Plain"># scenarios</span>
<span class="l l-Scalar l-Scalar-Plain">$thumbprint = (Get-ChildItem -Path cert:\LocalMachine\root | Where-Object { $_.Subject -eq &quot;CN=$username&quot; }).Thumbprint</span>

<span class="l l-Scalar l-Scalar-Plain">New-Item -Path WSMan:\localhost\ClientCertificate `</span>
    <span class="l l-Scalar l-Scalar-Plain">-Subject &quot;$username@localhost&quot; `</span>
    <span class="l l-Scalar l-Scalar-Plain">-URI * `</span>
    <span class="l l-Scalar l-Scalar-Plain">-Issuer $thumbprint `</span>
    <span class="l l-Scalar l-Scalar-Plain">-Credential $credential `</span>
    <span class="l l-Scalar l-Scalar-Plain">-Force</span>
</pre></div>
</div>
<p>Once this is complete, the hostvar <code class="docutils literal notranslate"><span class="pre">ansible_winrm_cert_pem</span></code> should be set to
the path of the public key and the <code class="docutils literal notranslate"><span class="pre">ansible_winrm_cert_key_pem</span></code> variable should be set to
the path of the private key.</p>
</div>
</div>
<div class="section" id="ntlm">
<h3><a class="toc-backref" href="#id8">NTLM</a><a class="headerlink" href="#ntlm" title="Permalink to this headline">¶</a></h3>
<p>NTLM is an older authentication mechanism used by Microsoft that can support
both local and domain accounts. NTLM is enabled by default on the WinRM
service, so no setup is required before using it.</p>
<p>NTLM is the easiest authentication protocol to use and is more secure than
<code class="docutils literal notranslate"><span class="pre">Basic</span></code> authentication. If running in a domain environment, <code class="docutils literal notranslate"><span class="pre">Kerberos</span></code> should be used
instead of NTLM.</p>
<p>Kerberos has several advantages over using NTLM:</p>
<ul class="simple">
<li><p>NTLM is an older protocol and does not support newer encryption
protocols.</p></li>
<li><p>NTLM is slower to authenticate because it requires more round trips to the host in
the authentication stage.</p></li>
<li><p>Unlike Kerberos, NTLM does not allow credential delegation.</p></li>
</ul>
<p>This example shows host variables configured to use NTLM authentication:</p>
<div class="highlight-yaml+jinja notranslate"><div class="highlight"><pre><span></span><span class="nt">ansible_user</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">LocalUsername</span>
<span class="nt">ansible_password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Password</span>
<span class="nt">ansible_connection</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">winrm</span>
<span class="nt">ansible_winrm_transport</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ntlm</span>
</pre></div>
</div>
</div>
<div class="section" id="kerberos">
<h3><a class="toc-backref" href="#id9">Kerberos</a><a class="headerlink" href="#kerberos" title="Permalink to this headline">¶</a></h3>
<p>Kerberos is the recommended authentication option to use when running in a
domain environment. Kerberos supports features like credential delegation and
message encryption over HTTP and is one of the more secure options that
is available through WinRM.</p>
<p>Kerberos requires some additional setup work on the Ansible host before it can be
used properly.</p>
<p>The following example shows host vars configured for Kerberos authentication:</p>
<div class="highlight-yaml+jinja notranslate"><div class="highlight"><pre><span></span><span class="nt">ansible_user</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">username@MY.DOMAIN.COM</span>
<span class="nt">ansible_password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Password</span>
<span class="nt">ansible_connection</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">winrm</span>
<span class="nt">ansible_winrm_transport</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kerberos</span>
</pre></div>
</div>
<p>As of Ansible version 2.3, the Kerberos ticket will be created based on
<code class="docutils literal notranslate"><span class="pre">ansible_user</span></code> and <code class="docutils literal notranslate"><span class="pre">ansible_password</span></code>. If running on an older version of
Ansible or when <code class="docutils literal notranslate"><span class="pre">ansible_winrm_kinit_mode</span></code> is <code class="docutils literal notranslate"><span class="pre">manual</span></code>, a Kerberos
ticket must already be obtained. See below for more details.</p>
<p>There are some extra host variables that can be set:</p>
<div class="highlight-YAML+Jinja notranslate"><div class="highlight"><pre><span></span><span class="nt">ansible_winrm_kinit_mode</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">managed/manual (manual means Ansible will not obtain a ticket)</span>
<span class="nt">ansible_winrm_kinit_cmd</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">the kinit binary to use to obtain a Kerberos ticket (default to kinit)</span>
<span class="nt">ansible_winrm_service</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">overrides the SPN prefix that is used, the default is ``HTTP`` and should rarely ever need changing</span>
<span class="nt">ansible_winrm_kerberos_delegation</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">allows the credentials to traverse multiple hops</span>
<span class="nt">ansible_winrm_kerberos_hostname_override</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">the hostname to be used for the kerberos exchange</span>
</pre></div>
</div>
<div class="section" id="installing-the-kerberos-library">
<h4><a class="toc-backref" href="#id10">Installing the Kerberos Library</a><a class="headerlink" href="#installing-the-kerberos-library" title="Permalink to this headline">¶</a></h4>
<p>Some system dependencies that must be installed prior to using Kerberos. The script below lists the dependencies based on the distro:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># Via Yum (RHEL/Centos/Fedora)</span>
yum -y install python-devel krb5-devel krb5-libs krb5-workstation

<span class="c1"># Via Apt (Ubuntu)</span>
sudo apt-get install python-dev libkrb5-dev krb5-user

<span class="c1"># Via Portage (Gentoo)</span>
emerge -av app-crypt/mit-krb5
emerge -av dev-python/setuptools

<span class="c1"># Via Pkg (FreeBSD)</span>
sudo pkg install security/krb5

<span class="c1"># Via OpenCSW (Solaris)</span>
pkgadd -d http://get.opencsw.org/now
/opt/csw/bin/pkgutil -U
/opt/csw/bin/pkgutil -y -i libkrb5_3

<span class="c1"># Via Pacman (Arch Linux)</span>
pacman -S krb5
</pre></div>
</div>
<p>Once the dependencies have been installed, the <code class="docutils literal notranslate"><span class="pre">python-kerberos</span></code> wrapper can
be install using <code class="docutils literal notranslate"><span class="pre">pip</span></code>:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pip install pywinrm<span class="o">[</span>kerberos<span class="o">]</span>
</pre></div>
</div>
</div>
<div class="section" id="configuring-host-kerberos">
<h4><a class="toc-backref" href="#id11">Configuring Host Kerberos</a><a class="headerlink" href="#configuring-host-kerberos" title="Permalink to this headline">¶</a></h4>
<p>Once the dependencies have been installed, Kerberos needs to be configured so
that it can communicate with a domain. This configuration is done through the
<code class="docutils literal notranslate"><span class="pre">/etc/krb5.conf</span></code> file, which is installed with the packages in the script above.</p>
<p>To configure Kerberos, in the section that starts with:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[realms]</span>
</pre></div>
</div>
<p>Add the full domain name and the fully qualified domain names of the primary
and secondary Active Directory domain controllers. It should look something
like this:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[realms]</span>
    <span class="na">MY.DOMAIN.COM</span> <span class="o">=</span> <span class="s">{</span>
<span class="s">        kdc = domain-controller1.my.domain.com</span>
<span class="s">        kdc = domain-controller2.my.domain.com</span>
<span class="s">    }</span>
</pre></div>
</div>
<p>In the section that starts with:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[domain_realm]</span>
</pre></div>
</div>
<p>Add a line like the following for each domain that Ansible needs access for:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[domain_realm]</span>
    <span class="na">.my.domain.com</span> <span class="o">=</span> <span class="s">MY.DOMAIN.COM</span>
</pre></div>
</div>
<p>You can configure other settings in this file such as the default domain. See
<a class="reference external" href="https://web.mit.edu/kerberos/krb5-1.12/doc/admin/conf_files/krb5_conf.html">krb5.conf</a>
for more details.</p>
</div>
<div class="section" id="automatic-kerberos-ticket-management">
<h4><a class="toc-backref" href="#id12">Automatic Kerberos Ticket Management</a><a class="headerlink" href="#automatic-kerberos-ticket-management" title="Permalink to this headline">¶</a></h4>
<p>Ansible version 2.3 and later defaults to automatically managing Kerberos tickets
when both <code class="docutils literal notranslate"><span class="pre">ansible_user</span></code> and <code class="docutils literal notranslate"><span class="pre">ansible_password</span></code> are specified for a host. In
this process, a new ticket is created in a temporary credential cache for each
host. This is done before each task executes to minimize the chance of ticket
expiration. The temporary credential caches are deleted after each task
completes and will not interfere with the default credential cache.</p>
<p>To disable automatic ticket management, set <code class="docutils literal notranslate"><span class="pre">ansible_winrm_kinit_mode=manual</span></code>
via the inventory.</p>
<p>Automatic ticket management requires a standard <code class="docutils literal notranslate"><span class="pre">kinit</span></code> binary on the control
host system path. To specify a different location or binary name, set the
<code class="docutils literal notranslate"><span class="pre">ansible_winrm_kinit_cmd</span></code> hostvar to the fully qualified path to a MIT krbv5
<code class="docutils literal notranslate"><span class="pre">kinit</span></code>-compatible binary.</p>
</div>
<div class="section" id="manual-kerberos-ticket-management">
<h4><a class="toc-backref" href="#id13">Manual Kerberos Ticket Management</a><a class="headerlink" href="#manual-kerberos-ticket-management" title="Permalink to this headline">¶</a></h4>
<p>To manually manage Kerberos tickets, the <code class="docutils literal notranslate"><span class="pre">kinit</span></code> binary is used. To
obtain a new ticket the following command is used:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>kinit username@MY.DOMAIN.COM
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The domain must match the configured Kerberos realm exactly, and must be in upper case.</p>
</div>
<p>To see what tickets (if any) have been acquired, use the following command:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>klist
</pre></div>
</div>
<p>To destroy all the tickets that have been acquired, use the following command:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>kdestroy
</pre></div>
</div>
</div>
<div class="section" id="troubleshooting-kerberos">
<h4><a class="toc-backref" href="#id14">Troubleshooting Kerberos</a><a class="headerlink" href="#troubleshooting-kerberos" title="Permalink to this headline">¶</a></h4>
<p>Kerberos is reliant on a properly-configured environment to
work. To troubleshoot Kerberos issues, ensure that:</p>
<ul>
<li><p>The hostname set for the Windows host is the FQDN and not an IP address.</p></li>
<li><p>The forward and reverse DNS lookups are working properly in the domain. To
test this, ping the windows host by name and then use the ip address returned
with <code class="docutils literal notranslate"><span class="pre">nslookup</span></code>. The same name should be returned when using <code class="docutils literal notranslate"><span class="pre">nslookup</span></code>
on the IP address.</p></li>
<li><p>The Ansible host’s clock is synchronized with the domain controller. Kerberos
is time sensitive, and a little clock drift can cause the ticket generation
process to fail.</p></li>
<li><p>Ensure that the fully qualified domain name for the domain is configured in
the <code class="docutils literal notranslate"><span class="pre">krb5.conf</span></code> file. To check this, run:</p>
<div class="highlight-YAML+Jinja notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">kinit -C username@MY.DOMAIN.COM</span>
<span class="l l-Scalar l-Scalar-Plain">klist</span>
</pre></div>
</div>
<p>If the domain name returned by <code class="docutils literal notranslate"><span class="pre">klist</span></code> is different from the one requested,
an alias is being used. The <code class="docutils literal notranslate"><span class="pre">krb5.conf</span></code> file needs to be updated so that
the fully qualified domain name is used and not an alias.</p>
</li>
<li><p>If the default kerberos tooling has been replaced or modified (some IdM solutions may do this), this may cause issues when installing or upgrading the Python Kerberos library. As of the time of this writing, this library is called <code class="docutils literal notranslate"><span class="pre">pykerberos</span></code> and is known to work with both MIT and Heimdal Kerberos libraries. To resolve <code class="docutils literal notranslate"><span class="pre">pykerberos</span></code> installation issues, ensure the system dependencies for Kerberos have been met (see: <a class="reference internal" href="#installing-the-kerberos-library">Installing the Kerberos Library</a>), remove any custom Kerberos tooling paths from the PATH environment variable, and retry the installation of Python Kerberos library package.</p></li>
</ul>
</div>
</div>
<div class="section" id="credssp">
<h3><a class="toc-backref" href="#id15">CredSSP</a><a class="headerlink" href="#credssp" title="Permalink to this headline">¶</a></h3>
<p>CredSSP authentication is a newer authentication protocol that allows
credential delegation. This is achieved by encrypting the username and password
after authentication has succeeded and sending that to the server using the
CredSSP protocol.</p>
<p>Because the username and password are sent to the server to be used for double
hop authentication, ensure that the hosts that the Windows host communicates with are
not compromised and are trusted.</p>
<p>CredSSP can be used for both local and domain accounts and also supports
message encryption over HTTP.</p>
<p>To use CredSSP authentication, the host vars are configured like so:</p>
<div class="highlight-yaml+jinja notranslate"><div class="highlight"><pre><span></span><span class="nt">ansible_user</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Username</span>
<span class="nt">ansible_password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Password</span>
<span class="nt">ansible_connection</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">winrm</span>
<span class="nt">ansible_winrm_transport</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">credssp</span>
</pre></div>
</div>
<p>There are some extra host variables that can be set as shown below:</p>
<div class="highlight-YAML+Jinja notranslate"><div class="highlight"><pre><span></span><span class="nt">ansible_winrm_credssp_disable_tlsv1_2</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">when true, will not use TLS 1.2 in the CredSSP auth process</span>
</pre></div>
</div>
<p>CredSSP authentication is not enabled by default on a Windows host, but can
be enabled by running the following in PowerShell:</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="nb">Enable-WSManCredSSP</span> <span class="n">-Role</span> <span class="n">Server</span> <span class="n">-Force</span>
</pre></div>
</div>
<div class="section" id="installing-credssp-library">
<h4><a class="toc-backref" href="#id16">Installing CredSSP Library</a><a class="headerlink" href="#installing-credssp-library" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">requests-credssp</span></code> wrapper can be installed using <code class="docutils literal notranslate"><span class="pre">pip</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip install pywinrm<span class="o">[</span>credssp<span class="o">]</span>
</pre></div>
</div>
</div>
<div class="section" id="credssp-and-tls-1-2">
<h4><a class="toc-backref" href="#id17">CredSSP and TLS 1.2</a><a class="headerlink" href="#credssp-and-tls-1-2" title="Permalink to this headline">¶</a></h4>
<p>By default the <code class="docutils literal notranslate"><span class="pre">requests-credssp</span></code> library is configured to authenticate over
the TLS 1.2 protocol. TLS 1.2 is installed and enabled by default for Windows Server 2012
and Windows 8 and more recent releases.</p>
<p>There are two ways that older hosts can be used with CredSSP:</p>
<ul class="simple">
<li><p>Install and enable a hotfix to enable TLS 1.2 support (recommended
for Server 2008 R2 and Windows 7).</p></li>
<li><p>Set <code class="docutils literal notranslate"><span class="pre">ansible_winrm_credssp_disable_tlsv1_2=True</span></code> in the inventory to run
over TLS 1.0. This is the only option when connecting to Windows Server 2008, which
has no way of supporting TLS 1.2</p></li>
</ul>
<p>See <a class="reference internal" href="#winrm-tls12"><span class="std std-ref">TLS 1.2 Support</span></a> for more information on how to enable TLS 1.2 on the
Windows host.</p>
</div>
<div class="section" id="set-credssp-certificate">
<h4><a class="toc-backref" href="#id18">Set CredSSP Certificate</a><a class="headerlink" href="#set-credssp-certificate" title="Permalink to this headline">¶</a></h4>
<p>CredSSP works by encrypting the credentials through the TLS protocol and uses a self-signed certificate by default. The <code class="docutils literal notranslate"><span class="pre">CertificateThumbprint</span></code> option under the WinRM service configuration can be used to specify the thumbprint of
another certificate.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This certificate configuration is independent of the WinRM listener
certificate. With CredSSP, message transport still occurs over the WinRM listener,
but the TLS-encrypted messages inside the channel use the service-level certificate.</p>
</div>
<p>To explicitly set the certificate to use for CredSSP:</p>
<div class="highlight-YAML+Jinja notranslate"><div class="highlight"><pre><span></span><span class="c1"># Note the value $certificate_thumbprint will be different in each</span>
<span class="c1"># situation, this needs to be set based on the cert that is used.</span>
<span class="l l-Scalar l-Scalar-Plain">$certificate_thumbprint = &quot;7C8DCBD5427AFEE6560F4AF524E325915F51172C&quot;</span>

<span class="l l-Scalar l-Scalar-Plain"># Set the thumbprint value</span>
<span class="l l-Scalar l-Scalar-Plain">Set-Item -Path WSMan:\localhost\Service\CertificateThumbprint -Value $certificate_thumbprint</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="non-administrator-accounts">
<h2><a class="toc-backref" href="#id19">Non-Administrator Accounts</a><a class="headerlink" href="#non-administrator-accounts" title="Permalink to this headline">¶</a></h2>
<p>WinRM is configured by default to only allow connections from accounts in the local
<code class="docutils literal notranslate"><span class="pre">Administrators</span></code> group. This can be changed by running:</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="n">winrm</span> <span class="n">configSDDL</span> <span class="k">default</span>
</pre></div>
</div>
<p>This will display an ACL editor, where new users or groups may be added. To run commands
over WinRM, users and groups must have at least the <code class="docutils literal notranslate"><span class="pre">Read</span></code> and <code class="docutils literal notranslate"><span class="pre">Execute</span></code> permissions
enabled.</p>
<p>While non-administrative accounts can be used with WinRM, most typical server administration
tasks require some level of administrative access, so the utility is usually limited.</p>
</div>
<div class="section" id="winrm-encryption">
<h2><a class="toc-backref" href="#id20">WinRM Encryption</a><a class="headerlink" href="#winrm-encryption" title="Permalink to this headline">¶</a></h2>
<p>By default WinRM will fail to work when running over an unencrypted channel.
The WinRM protocol considers the channel to be encrypted if using TLS over HTTP
(HTTPS) or using message level encryption. Using WinRM with TLS is the
recommended option as it works with all authentication options, but requires
a certificate to be created and used on the WinRM listener.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ConfigureRemotingForAnsible.ps1</span></code> creates a self-signed certificate and
creates the listener with that certificate. If in a domain environment, ADCS
can also create a certificate for the host that is issued by the domain itself.</p>
<p>If using HTTPS is not an option, then HTTP can be used when the authentication
option is <code class="docutils literal notranslate"><span class="pre">NTLM</span></code>, <code class="docutils literal notranslate"><span class="pre">Kerberos</span></code> or <code class="docutils literal notranslate"><span class="pre">CredSSP</span></code>. These protocols will encrypt
the WinRM payload with their own encryption method before sending it to the
server. The message-level encryption is not used when running over HTTPS because the
encryption uses the more secure TLS protocol instead. If both transport and
message encryption is required, set <code class="docutils literal notranslate"><span class="pre">ansible_winrm_message_encryption=always</span></code>
in the host vars.</p>
<p>A last resort is to disable the encryption requirement on the Windows host. This
should only be used for development and debugging purposes, as anything sent
from Ansible can be viewed, manipulated and also the remote session can completely
be taken over by anyone on the same network. To disable the encryption
requirement:</p>
<div class="highlight-YAML+Jinja notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">Set-Item -Path WSMan:\localhost\Service\AllowUnencrypted -Value $true</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Do not disable the encryption check unless it is
absolutely required. Doing so could allow sensitive information like
credentials and files to be intercepted by others on the network.</p>
</div>
</div>
<div class="section" id="inventory-options">
<h2><a class="toc-backref" href="#id21">Inventory Options</a><a class="headerlink" href="#inventory-options" title="Permalink to this headline">¶</a></h2>
<p>Ansible’s Windows support relies on a few standard variables to indicate the
username, password, and connection type of the remote hosts. These variables
are most easily set up in the inventory, but can be set on the <code class="docutils literal notranslate"><span class="pre">host_vars</span></code>/
<code class="docutils literal notranslate"><span class="pre">group_vars</span></code> level.</p>
<p>When setting up the inventory, the following variables are required:</p>
<div class="highlight-yaml+jinja notranslate"><div class="highlight"><pre><span></span><span class="c1"># It is suggested that these be encrypted with ansible-vault:</span>
<span class="c1"># ansible-vault edit group_vars/windows.yml</span>
<span class="nt">ansible_connection</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">winrm</span>

<span class="c1"># May also be passed on the command-line via --user</span>
<span class="nt">ansible_user</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Administrator</span>

<span class="c1"># May also be supplied at runtime with --ask-pass</span>
<span class="nt">ansible_password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">SecretPasswordGoesHere</span>
</pre></div>
</div>
<p>Using the variables above, Ansible will connect to the Windows host with Basic
authentication through HTTPS. If <code class="docutils literal notranslate"><span class="pre">ansible_user</span></code> has a UPN value like
<code class="docutils literal notranslate"><span class="pre">username&#64;MY.DOMAIN.COM</span></code> then the authentication option will automatically attempt
to use Kerberos unless <code class="docutils literal notranslate"><span class="pre">ansible_winrm_transport</span></code> has been set to something other than
<code class="docutils literal notranslate"><span class="pre">kerberos</span></code>.</p>
<p>The following custom inventory variables are also supported
for additional configuration of WinRM connections:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ansible_port</span></code>: The port WinRM will run over, HTTPS is <code class="docutils literal notranslate"><span class="pre">5986</span></code> which is
the default while HTTP is <code class="docutils literal notranslate"><span class="pre">5985</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ansible_winrm_scheme</span></code>: Specify the connection scheme (<code class="docutils literal notranslate"><span class="pre">http</span></code> or
<code class="docutils literal notranslate"><span class="pre">https</span></code>) to use for the WinRM connection. Ansible uses <code class="docutils literal notranslate"><span class="pre">https</span></code> by default
unless <code class="docutils literal notranslate"><span class="pre">ansible_port</span></code> is <code class="docutils literal notranslate"><span class="pre">5985</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ansible_winrm_path</span></code>: Specify an alternate path to the WinRM endpoint,
Ansible uses <code class="docutils literal notranslate"><span class="pre">/wsman</span></code> by default</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ansible_winrm_realm</span></code>: Specify the realm to use for Kerberos
authentication. If <code class="docutils literal notranslate"><span class="pre">ansible_user</span></code> contains <code class="docutils literal notranslate"><span class="pre">&#64;</span></code>, Ansible will use the part
of the username after <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> by default</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ansible_winrm_transport</span></code>: Specify one or more authentication transport
options as a comma-separated list. By default, Ansible will use <code class="docutils literal notranslate"><span class="pre">kerberos,</span>
<span class="pre">basic</span></code> if the <code class="docutils literal notranslate"><span class="pre">kerberos</span></code> module is installed and a realm is defined,
otherwise it will be <code class="docutils literal notranslate"><span class="pre">plaintext</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ansible_winrm_server_cert_validation</span></code>: Specify the server certificate
validation mode (<code class="docutils literal notranslate"><span class="pre">ignore</span></code> or <code class="docutils literal notranslate"><span class="pre">validate</span></code>). Ansible defaults to
<code class="docutils literal notranslate"><span class="pre">validate</span></code> on Python 2.7.9 and higher, which will result in certificate
validation errors against the Windows self-signed certificates. Unless
verifiable certificates have been configured on the WinRM listeners, this
should be set to <code class="docutils literal notranslate"><span class="pre">ignore</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ansible_winrm_operation_timeout_sec</span></code>: Increase the default timeout for
WinRM operations, Ansible uses <code class="docutils literal notranslate"><span class="pre">20</span></code> by default</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ansible_winrm_read_timeout_sec</span></code>: Increase the WinRM read timeout, Ansible
uses <code class="docutils literal notranslate"><span class="pre">30</span></code> by default. Useful if there are intermittent network issues and
read timeout errors keep occurring</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ansible_winrm_message_encryption</span></code>: Specify the message encryption
operation (<code class="docutils literal notranslate"><span class="pre">auto</span></code>, <code class="docutils literal notranslate"><span class="pre">always</span></code>, <code class="docutils literal notranslate"><span class="pre">never</span></code>) to use, Ansible uses <code class="docutils literal notranslate"><span class="pre">auto</span></code> by
default. <code class="docutils literal notranslate"><span class="pre">auto</span></code> means message encryption is only used when
<code class="docutils literal notranslate"><span class="pre">ansible_winrm_scheme</span></code> is <code class="docutils literal notranslate"><span class="pre">http</span></code> and <code class="docutils literal notranslate"><span class="pre">ansible_winrm_transport</span></code> supports
message encryption. <code class="docutils literal notranslate"><span class="pre">always</span></code> means message encryption will always be used
and <code class="docutils literal notranslate"><span class="pre">never</span></code> means message encryption will never be used</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ansible_winrm_ca_trust_path</span></code>: Used to specify a different cacert container
than the one used in the <code class="docutils literal notranslate"><span class="pre">certifi</span></code> module. See the HTTPS Certificate
Validation section for more details.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ansible_winrm_send_cbt</span></code>: When using <code class="docutils literal notranslate"><span class="pre">ntlm</span></code> or <code class="docutils literal notranslate"><span class="pre">kerberos</span></code> over HTTPS,
the authentication library will try to send channel binding tokens to
mitigate against man in the middle attacks. This flag controls whether these
bindings will be sent or not (default: <code class="docutils literal notranslate"><span class="pre">yes</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ansible_winrm_*</span></code>: Any additional keyword arguments supported by
<code class="docutils literal notranslate"><span class="pre">winrm.Protocol</span></code> may be provided in place of <code class="docutils literal notranslate"><span class="pre">*</span></code></p></li>
</ul>
<p>In addition, there are also specific variables that need to be set
for each authentication option. See the section on authentication above for more information.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Ansible 2.0 has deprecated the “ssh” from <code class="docutils literal notranslate"><span class="pre">ansible_ssh_user</span></code>,
<code class="docutils literal notranslate"><span class="pre">ansible_ssh_pass</span></code>, <code class="docutils literal notranslate"><span class="pre">ansible_ssh_host</span></code>, and <code class="docutils literal notranslate"><span class="pre">ansible_ssh_port</span></code> to
become <code class="docutils literal notranslate"><span class="pre">ansible_user</span></code>, <code class="docutils literal notranslate"><span class="pre">ansible_password</span></code>, <code class="docutils literal notranslate"><span class="pre">ansible_host</span></code>, and
<code class="docutils literal notranslate"><span class="pre">ansible_port</span></code>. If using a version of Ansible prior to 2.0, the older
style (<code class="docutils literal notranslate"><span class="pre">ansible_ssh_*</span></code>) should be used instead. The shorter variables
are ignored, without warning, in older versions of Ansible.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">ansible_winrm_message_encryption</span></code> is different from transport
encryption done over TLS. The WinRM payload is still encrypted with TLS
when run over HTTPS, even if <code class="docutils literal notranslate"><span class="pre">ansible_winrm_message_encryption=never</span></code>.</p>
</div>
</div>
<div class="section" id="ipv6-addresses">
<h2><a class="toc-backref" href="#id22">IPv6 Addresses</a><a class="headerlink" href="#ipv6-addresses" title="Permalink to this headline">¶</a></h2>
<p>IPv6 addresses can be used instead of IPv4 addresses or hostnames. This option
is normally set in an inventory. Ansible will attempt to parse the address
using the <a class="reference external" href="https://docs.python.org/3/library/ipaddress.html">ipaddress</a>
package and pass to pywinrm correctly.</p>
<p>When defining a host using an IPv6 address, just add the IPv6 address as you
would an IPv4 address or hostname:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[windows-server]</span>
<span class="na">2001:db8::1</span>

<span class="k">[windows-server:vars]</span>
<span class="na">ansible_user</span><span class="o">=</span><span class="s">username</span>
<span class="na">ansible_password</span><span class="o">=</span><span class="s">password</span>
<span class="na">ansible_connection</span><span class="o">=</span><span class="s">winrm</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The ipaddress library is only included by default in Python 3.x. To
use IPv6 addresses in Python 2.7, make sure to run <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">ipaddress</span></code> which installs
a backported package.</p>
</div>
</div>
<div class="section" id="https-certificate-validation">
<h2><a class="toc-backref" href="#id23">HTTPS Certificate Validation</a><a class="headerlink" href="#https-certificate-validation" title="Permalink to this headline">¶</a></h2>
<p>As part of the TLS protocol, the certificate is validated to ensure the host
matches the subject and the client trusts the issuer of the server certificate.
When using a self-signed certificate or setting
<code class="docutils literal notranslate"><span class="pre">ansible_winrm_server_cert_validation:</span> <span class="pre">ignore</span></code> these security mechanisms are
bypassed. While self signed certificates will always need the <code class="docutils literal notranslate"><span class="pre">ignore</span></code> flag,
certificates that have been issued from a certificate authority can still be
validated.</p>
<p>One of the more common ways of setting up a HTTPS listener in a domain
environment is to use Active Directory Certificate Service (AD CS). AD CS is
used to generate signed certificates from a Certificate Signing Request (CSR).
If the WinRM HTTPS listener is using a certificate that has been signed by
another authority, like AD CS, then Ansible can be set up to trust that
issuer as part of the TLS handshake.</p>
<p>To get Ansible to trust a Certificate Authority (CA) like AD CS, the issuer
certificate of the CA can be exported as a PEM encoded certificate. This
certificate can then be copied locally to the Ansible controller and used as a
source of certificate validation, otherwise known as a CA chain.</p>
<p>The CA chain can contain a single or multiple issuer certificates and each
entry is contained on a new line. To then use the custom CA chain as part of
the validation process, set <code class="docutils literal notranslate"><span class="pre">ansible_winrm_ca_trust_path</span></code> to the path of the
file. If this variable is not set, the default CA chain is used instead which
is located in the install path of the Python package
<a class="reference external" href="https://github.com/certifi/python-certifi">certifi</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Each HTTP call is done by the Python requests library which does not
use the systems built-in certificate store as a trust authority.
Certificate validation will fail if the server’s certificate issuer is
only added to the system’s truststore.</p>
</div>
</div>
<div class="section" id="tls-1-2-support">
<span id="winrm-tls12"></span><h2><a class="toc-backref" href="#id24">TLS 1.2 Support</a><a class="headerlink" href="#tls-1-2-support" title="Permalink to this headline">¶</a></h2>
<p>As WinRM runs over the HTTP protocol, using HTTPS means that the TLS protocol
is used to encrypt the WinRM messages. TLS will automatically attempt to
negotiate the best protocol and cipher suite that is available to both the
client and the server. If a match cannot be found then Ansible will error out
with a message similar to:</p>
<div class="highlight-YAML+Jinja notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">HTTPSConnectionPool(host=&#39;server&#39;, port=5986)</span><span class="p p-Indicator">:</span> <span class="nt">Max retries exceeded with url</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/wsman (Caused by SSLError(SSLError(1, &#39;[SSL</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">UNSUPPORTED_PROTOCOL] unsupported protocol (_ssl.c:1056)&#39;)))</span>
</pre></div>
</div>
<p>Commonly this is when the Windows host has not been configured to support
TLS v1.2 but it could also mean the Ansible controller has an older OpenSSL
version installed.</p>
<p>Windows 8 and Windows Server 2012 come with TLS v1.2 installed and enabled by
default but older hosts, like Server 2008 R2 and Windows 7, have to be enabled
manually.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There is a bug with the TLS 1.2 patch for Server 2008 which will stop
Ansible from connecting to the Windows host. This means that Server 2008
cannot be configured to use TLS 1.2. Server 2008 R2 and Windows 7 are not
affected by this issue and can use TLS 1.2.</p>
</div>
<p>To verify what protocol the Windows host supports, you can run the following
command on the Ansible controller:</p>
<div class="highlight-YAML+Jinja notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">openssl s_client -connect &lt;hostname&gt;:5986</span>
</pre></div>
</div>
<p>The output will contain information about the TLS session and the <code class="docutils literal notranslate"><span class="pre">Protocol</span></code>
line will display the version that was negotiated:</p>
<div class="highlight-YAML+Jinja notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">New, TLSv1/SSLv3, Cipher is ECDHE-RSA-AES256-SHA</span>
<span class="l l-Scalar l-Scalar-Plain">Server public key is 2048 bit</span>
<span class="l l-Scalar l-Scalar-Plain">Secure Renegotiation IS supported</span>
<span class="l l-Scalar l-Scalar-Plain">Compression</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">NONE</span>
<span class="nt">Expansion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">NONE</span>
<span class="l l-Scalar l-Scalar-Plain">No ALPN negotiated</span>
<span class="nt">SSL-Session</span><span class="p">:</span>
    <span class="nt">Protocol  </span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TLSv1</span>
    <span class="nt">Cipher    </span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ECDHE-RSA-AES256-SHA</span>
    <span class="nt">Session-ID</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">962A00001C95D2A601BE1CCFA7831B85A7EEE897AECDBF3D9ECD4A3BE4F6AC9B</span>
    <span class="nt">Session-ID-ctx</span><span class="p">:</span>
    <span class="nt">Master-Key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">....</span>
    <span class="nt">Start Time</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1552976474</span>
    <span class="nt">Timeout   </span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">7200 (sec)</span>
    <span class="nt">Verify return code</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">21 (unable to verify the first certificate)</span>
<span class="nn">---</span>

<span class="l l-Scalar l-Scalar-Plain">New, TLSv1/SSLv3, Cipher is ECDHE-RSA-AES256-GCM-SHA384</span>
<span class="l l-Scalar l-Scalar-Plain">Server public key is 2048 bit</span>
<span class="l l-Scalar l-Scalar-Plain">Secure Renegotiation IS supported</span>
<span class="l l-Scalar l-Scalar-Plain">Compression</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">NONE</span>
<span class="nt">Expansion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">NONE</span>
<span class="l l-Scalar l-Scalar-Plain">No ALPN negotiated</span>
<span class="nt">SSL-Session</span><span class="p">:</span>
    <span class="nt">Protocol  </span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">TLSv1.2</span>
    <span class="nt">Cipher    </span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ECDHE-RSA-AES256-GCM-SHA384</span>
    <span class="nt">Session-ID</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">AE16000050DA9FD44D03BB8839B64449805D9E43DBD670346D3D9E05D1AEEA84</span>
    <span class="nt">Session-ID-ctx</span><span class="p">:</span>
    <span class="nt">Master-Key</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">....</span>
    <span class="nt">Start Time</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1552976538</span>
    <span class="nt">Timeout   </span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">7200 (sec)</span>
    <span class="nt">Verify return code</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">21 (unable to verify the first certificate)</span>
</pre></div>
</div>
<p>If the host is returning <code class="docutils literal notranslate"><span class="pre">TLSv1</span></code> then it should be configured so that
TLS v1.2 is enable. You can do this by running the following PowerShell
script:</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="k">Function</span> <span class="nb">Enable-TLS12</span> <span class="p">{</span>
    <span class="k">param</span><span class="p">(</span>
        <span class="p">[</span><span class="k">ValidateSet</span><span class="p">(</span><span class="s2">&quot;Server&quot;</span><span class="p">,</span> <span class="s2">&quot;Client&quot;</span><span class="p">)]</span>
        <span class="no">[String]</span><span class="nv">$Component</span> <span class="p">=</span> <span class="s2">&quot;Server&quot;</span>
    <span class="p">)</span>

    <span class="nv">$protocols_path</span> <span class="p">=</span> <span class="s1">&#39;HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols&#39;</span>
    <span class="nb">New-Item</span> <span class="n">-Path</span> <span class="s2">&quot;$protocols_path\TLS 1.2\$Component&quot;</span> <span class="n">-Force</span>
    <span class="nb">New-ItemProperty</span> <span class="n">-Path</span> <span class="s2">&quot;$protocols_path\TLS 1.2\$Component&quot;</span> <span class="n">-Name</span> <span class="n">Enabled</span> <span class="n">-Value</span> <span class="n">1</span> <span class="n">-Type</span> <span class="n">DWORD</span> <span class="n">-Force</span>
    <span class="nb">New-ItemProperty</span> <span class="n">-Path</span> <span class="s2">&quot;$protocols_path\TLS 1.2\$Component&quot;</span> <span class="n">-Name</span> <span class="n">DisabledByDefault</span> <span class="n">-Value</span> <span class="n">0</span> <span class="n">-Type</span> <span class="n">DWORD</span> <span class="n">-Force</span>
<span class="p">}</span>

<span class="nb">Enable-TLS12</span> <span class="n">-Component</span> <span class="n">Server</span>

<span class="c"># Not required but highly recommended to enable the Client side TLS 1.2 components</span>
<span class="nb">Enable-TLS12</span> <span class="n">-Component</span> <span class="n">Client</span>

<span class="nb">Restart-Computer</span>
</pre></div>
</div>
<p>The below Ansible tasks can also be used to enable TLS v1.2:</p>
<div class="highlight-yaml+jinja notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">enable TLSv1.2 support</span>
  <span class="nt">win_regedit</span><span class="p">:</span>
    <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\TLS 1.2\</span><span class="cp">{{</span> <span class="nv">item.type</span> <span class="cp">}}</span>
    <span class="nt">name</span><span class="p">:</span> <span class="s">&#39;</span><span class="cp">{{</span> <span class="nv">item.property</span> <span class="cp">}}</span><span class="s">&#39;</span>
    <span class="nt">data</span><span class="p">:</span> <span class="s">&#39;</span><span class="cp">{{</span> <span class="nv">item.value</span> <span class="cp">}}</span><span class="s">&#39;</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">dword</span>
    <span class="nt">state</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
  <span class="nt">register</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">enable_tls12</span>
  <span class="nt">loop</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Server</span>
    <span class="nt">property</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Enabled</span>
    <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Server</span>
    <span class="nt">property</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">DisabledByDefault</span>
    <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Client</span>
    <span class="nt">property</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Enabled</span>
    <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class="p p-Indicator">-</span> <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Client</span>
    <span class="nt">property</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">DisabledByDefault</span>
    <span class="nt">value</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>

<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">reboot if TLS config was applied</span>
  <span class="nt">win_reboot</span><span class="p">:</span>
  <span class="nt">when</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">enable_tls12 is changed</span>
</pre></div>
</div>
<p>There are other ways to configure the TLS protocols as well as the cipher
suites that are offered by the Windows host. One tool that can give you a GUI
to manage these settings is <a class="reference external" href="https://www.nartac.com/Products/IISCrypto/">IIS Crypto</a>
from Nartac Software.</p>
</div>
<div class="section" id="limitations">
<h2><a class="toc-backref" href="#id25">Limitations</a><a class="headerlink" href="#limitations" title="Permalink to this headline">¶</a></h2>
<p>Due to the design of the WinRM protocol , there are a few limitations
when using WinRM that can cause issues when creating playbooks for Ansible.
These include:</p>
<ul class="simple">
<li><p>Credentials are not delegated for most authentication types, which causes
authentication errors when accessing network resources or installing certain
programs.</p></li>
<li><p>Many calls to the Windows Update API are blocked when running over WinRM.</p></li>
<li><p>Some programs fail to install with WinRM due to no credential delegation or
because they access forbidden Windows API like WUA over WinRM.</p></li>
<li><p>Commands under WinRM are done under a non-interactive session, which can prevent
certain commands or executables from running.</p></li>
<li><p>You cannot run a process that interacts with <code class="docutils literal notranslate"><span class="pre">DPAPI</span></code>, which is used by some
installers (like Microsoft SQL Server).</p></li>
</ul>
<p>Some of these limitations can be mitigated by doing one of the following:</p>
<ul class="simple">
<li><p>Set <code class="docutils literal notranslate"><span class="pre">ansible_winrm_transport</span></code> to <code class="docutils literal notranslate"><span class="pre">credssp</span></code> or <code class="docutils literal notranslate"><span class="pre">kerberos</span></code> (with
<code class="docutils literal notranslate"><span class="pre">ansible_winrm_kerberos_delegation=true</span></code>) to bypass the double hop issue
and access network resources</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">become</span></code> to bypass all WinRM restrictions and run a command as it would
locally. Unlike using an authentication transport like <code class="docutils literal notranslate"><span class="pre">credssp</span></code>, this will
also remove the non-interactive restriction and API restrictions like WUA and
DPAPI</p></li>
<li><p>Use a scheduled task to run a command which can be created with the
<code class="docutils literal notranslate"><span class="pre">win_scheduled_task</span></code> module. Like <code class="docutils literal notranslate"><span class="pre">become</span></code>, this bypasses all WinRM
restrictions but can only run a command and not modules.</p></li>
</ul>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<dl class="simple">
<dt><a class="reference internal" href="playbooks_intro.html#playbooks-intro"><span class="std std-ref">About Playbooks</span></a></dt><dd><p>An introduction to playbooks</p>
</dd>
<dt><a class="reference internal" href="playbooks_best_practices.html#playbooks-best-practices"><span class="std std-ref">Best Practices</span></a></dt><dd><p>Best practices advice</p>
</dd>
<dt><span class="xref std std-ref">List of Windows Modules</span></dt><dd><p>Windows specific module list, all implemented in PowerShell</p>
</dd>
<dt><a class="reference external" href="https://groups.google.com/group/ansible-project">User Mailing List</a></dt><dd><p>Have a question?  Stop by the google group!</p>
</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt><dd><p>#ansible IRC chat channel</p>
</dd>
</dl>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons">
      
        <a href="windows_usage.html" class="btn btn-neutral float-right" title="Using Ansible and Windows"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="windows_setup.html" class="btn btn-neutral" title="Setting up a Windows Host"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>


<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','yABGvz2N8PwcwBxyfzUc','2.0.0');
</script>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019 Red Hat, Inc.
      <span class="lastupdated">
        Last updated on Nov 03, 2020.
      </span>

    </p>
  </div> 
</footer>
        </div>
      </div>

    </section>

  </div>

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script>

  
  
    
   <!-- extra footer elements for Ansible beyond RTD Sphinx Theme --->
<!-- begin analytics -->
<script type="text/javascript">
var _hsq = _hsq || [];
_hsq.push(["setContentType", "standard-page"]);
      (function(d,s,i,r) {
      if (d.getElementById(i)){return;}
      var n = d.createElement(s),e = document.getElementsByTagName(s)[0];
      n.id=i;n.src = '//js.hs-analytics.net/analytics/'+(Math.ceil(new Date()/r)*r)+'/330046.js';
      e.parentNode.insertBefore(n, e);
      })(document, "script", "hs-analytics",300000);
</script>
<!-- end analytics -->
<script type="text/javascript">
if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
  _satellite.pageBottom();
}
</script> 

</body>
</html>